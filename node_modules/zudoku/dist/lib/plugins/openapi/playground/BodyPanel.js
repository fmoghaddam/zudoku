import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import { ChevronDownIcon, FileInput, Grid2x2PlusIcon, PaperclipIcon, ScanTextIcon, XIcon, } from "lucide-react";
import { useRef, useState } from "react";
import { useFormContext } from "react-hook-form";
import { Button } from "zudoku/components";
import { Collapsible, CollapsibleContent } from "zudoku/ui/Collapsible.js";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, } from "zudoku/ui/DropdownMenu.js";
import { Textarea } from "zudoku/ui/Textarea.js";
import { cn } from "../../../util/cn.js";
import { humanFileSize } from "../../../util/humanFileSize.js";
import { CollapsibleHeader, CollapsibleHeaderTrigger, } from "./CollapsibleHeader.js";
import ExamplesDropdown from "./ExamplesDropdown.js";
import ParamsGrid from "./ParamsGrid.js";
import { MultipartField } from "./request-panel/MultipartField.js";
import { useKeyValueFieldManager } from "./request-panel/useKeyValueFieldManager.js";
export const BodyPanel = ({ content }) => {
    const { register, setValue, watch, control } = useFormContext();
    const examples = (content ?? []).flatMap((e) => e.examples);
    const [headers, file, bodyMode, body, multipartFormFields] = watch([
        "headers",
        "file",
        "bodyMode",
        "body",
        "multipartFormFields",
    ]);
    const fileInputRef = useRef(null);
    const [isDragging, setIsDragging] = useState(false);
    const handleFileSelect = (selectedFile) => {
        setValue("file", selectedFile);
        if (!selectedFile)
            return;
        setValue("headers", headers.filter((h) => h.name.toLowerCase() !== "content-type" || !h.active));
    };
    const handleFileInputChange = (e) => {
        const selectedFile = e.target.files?.[0] ?? null;
        handleFileSelect(selectedFile);
    };
    const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(true);
    };
    const handleDragLeave = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
    };
    const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
        const droppedFile = e.dataTransfer.files?.[0] ?? null;
        handleFileSelect(droppedFile);
    };
    const manager = useKeyValueFieldManager({
        control,
        name: "multipartFormFields",
        defaultValue: { name: "", value: "", active: false },
        isEmpty: (item) => {
            if (item.value instanceof File)
                return false;
            return !item.name && !item.value;
        },
    });
    return (_jsxs(Collapsible, { defaultOpen: true, children: [_jsxs(CollapsibleHeaderTrigger, { className: "items-center", children: [_jsx(FileInput, { size: 16 }), _jsxs(CollapsibleHeader, { className: "flex items-center justify-between", children: ["Body", _jsxs("div", { className: "flex items-center", children: [_jsxs(DropdownMenu, { children: [_jsx(DropdownMenuTrigger, { asChild: true, children: _jsxs(Button, { variant: "ghost", size: "sm", className: "hover:bg-accent hover:brightness-95 gap-2", children: [bodyMode === "text" ? (_jsxs(_Fragment, { children: [_jsx(ScanTextIcon, { size: 14 }), "Text"] })) : bodyMode === "file" ? (_jsxs(_Fragment, { children: [_jsx(PaperclipIcon, { size: 14 }), "File"] })) : (_jsxs(_Fragment, { children: [_jsx(Grid2x2PlusIcon, { size: 14 }), "Multipart"] })), _jsx(ChevronDownIcon, { size: 14 })] }) }), _jsxs(DropdownMenuContent, { className: "min-w-40", children: [_jsxs(DropdownMenuItem, { onSelect: () => setValue("bodyMode", "text"), className: "gap-2", children: [_jsx(ScanTextIcon, { size: 14 }), _jsx("span", { className: "flex-1", children: "Text" }), _jsx("span", { children: body.length > 0 && (_jsx("div", { className: "w-1.5 h-1.5 bg-primary rounded-full" })) })] }), _jsxs(DropdownMenuItem, { onSelect: () => setValue("bodyMode", "file"), className: "gap-2", children: [_jsx(PaperclipIcon, { size: 14 }), _jsx("span", { className: "flex-1", children: "File" }), _jsx("span", { children: file && (_jsx("div", { className: "w-1.5 h-1.5 bg-primary rounded-full" })) })] }), _jsxs(DropdownMenuItem, { onSelect: () => setValue("bodyMode", "multipart"), className: "gap-2", children: [_jsx(Grid2x2PlusIcon, { size: 14, strokeWidth: 1.5 }), _jsx("span", { className: "flex-1", children: "Multipart" }), _jsx("span", { children: multipartFormFields?.some((field) => field.active) && (_jsx("div", { className: "w-1.5 h-1.5 bg-primary rounded-full" })) })] })] })] }), _jsx("input", { ref: fileInputRef, type: "file", className: "hidden", onChange: handleFileInputChange }), _jsx("div", { className: "w-px mx-1 h-5 bg-border" }), content && examples.length > 0 ? (_jsx(ExamplesDropdown, { examples: content, onSelect: (example, mediaType) => {
                                            setValue("body", JSON.stringify(example.value, null, 2));
                                            setValue("headers", [
                                                ...headers.filter((h) => h.name !== "Content-Type"),
                                                {
                                                    name: "Content-Type",
                                                    value: mediaType,
                                                    active: true,
                                                },
                                            ]);
                                        } })) : (_jsx("div", {}))] })] })] }), _jsxs(CollapsibleContent, { className: "CollapsibleContent flex flex-col gap-2", children: [bodyMode === "text" && (_jsx(Textarea, { ...register("body"), className: cn("w-full px-4 py-2.5 h-64 font-mono md:text-xs border-none rounded-none focus-visible:ring-0 transition-colors"), placeholder: "Body content" })), bodyMode === "file" && (_jsxs("div", { role: "region", "aria-label": "File upload drop zone", className: cn("flex flex-col items-center justify-center gap-4 min-h-[300px]"), onDragOver: handleDragOver, onDragLeave: handleDragLeave, onDrop: handleDrop, children: [_jsx("button", { type: "button", onClick: () => fileInputRef.current?.click(), className: cn("flex items-center justify-center gap-2 rounded-full size-20 p-0 border border-dashed border-muted-foreground/50 hover:bg-accent/75 transition-colors", (file || isDragging) && "border-solid", isDragging && "bg-accent border-primary"), children: _jsx(PaperclipIcon, { className: cn("text-muted-foreground", isDragging && "text-primary"), size: 30 }) }), file ? (_jsxs("div", { className: "flex items-center justify-between gap-2 px-2 py-1.5 rounded-md border", children: [_jsxs("span", { className: "text-sm truncate", title: file.name, children: [file.name, " ", _jsxs("span", { className: "text-muted-foreground", children: ["(", humanFileSize(file.size), ")"] })] }), _jsx(Button, { type: "button", variant: "ghost", size: "icon-xxs", onClick: () => handleFileSelect(null), children: _jsx(XIcon, { size: 14 }) })] })) : (_jsx("span", { className: "text-lg font-semibold text-muted-foreground", children: "Select or drop a file" }))] })), bodyMode === "multipart" && (_jsx(ParamsGrid, { children: manager.fields.map((field, index) => (_jsx(MultipartField, { index: index, manager: manager }, field.id))) }))] })] }));
};
export default BodyPanel;
//# sourceMappingURL=BodyPanel.js.map