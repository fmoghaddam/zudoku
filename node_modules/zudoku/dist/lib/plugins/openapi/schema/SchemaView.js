import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import { InfoIcon } from "lucide-react";
import { Fragment } from "react";
import { Frame, FrameDescription, FrameFooter, FrameHeader, FramePanel, } from "zudoku/ui/Frame.js";
import { ItemGroup, ItemSeparator } from "zudoku/ui/Item.js";
import { Markdown } from "../../../components/Markdown.js";
import { groupBy } from "../../../util/groupBy.js";
import { ConstValue } from "../components/ConstValue.js";
import { EnumValues } from "../components/EnumValues.js";
import { ParamInfos } from "../ParamInfos.js";
import { SchemaExampleAndDefault } from "./SchemaExampleAndDefault.js";
import { SchemaPropertyItem } from "./SchemaPropertyItem.js";
import { UnionView } from "./UnionView.js";
import { isArrayType, isBasicType } from "./utils.js";
const renderMarkdown = (content) => content && (_jsx(Markdown, { className: "text-sm leading-normal line-clamp-4", content: content }));
const renderBasicSchema = (schema, cardHeader, embedded) => {
    const content = (_jsxs(_Fragment, { children: [_jsx("span", { className: "text-sm text-muted-foreground", children: _jsx(ParamInfos, { schema: schema }) }), schema.enum && _jsx(EnumValues, { values: schema.enum }), renderMarkdown(schema.description), _jsx(SchemaExampleAndDefault, { schema: schema })] }));
    if (embedded) {
        return _jsx("div", { className: "space-y-2 p-4", children: content });
    }
    return (_jsxs(Frame, { children: [cardHeader, _jsx(FramePanel, { className: "space-y-2", children: content })] }));
};
export const SchemaView = ({ schema, defaultOpen = false, cardHeader, embedded, }) => {
    if (!schema || Object.keys(schema).length === 0) {
        return (_jsxs(Frame, { children: [cardHeader, _jsx(FramePanel, { children: _jsx("div", { className: "text-sm text-muted-foreground italic", children: "No data returned" }) })] }));
    }
    if (schema.const) {
        return _jsx(ConstValue, { schema: schema });
    }
    if (Array.isArray(schema.oneOf) || Array.isArray(schema.anyOf)) {
        return _jsx(UnionView, { schema: schema, cardHeader: cardHeader });
    }
    if (isBasicType(schema.type)) {
        return renderBasicSchema(schema, cardHeader, embedded);
    }
    if (isArrayType(schema) && typeof schema.items === "object") {
        const wrappedSchema = {
            type: "object",
            properties: { "": schema },
        };
        return (_jsx(SchemaView, { schema: wrappedSchema, cardHeader: cardHeader, defaultOpen: true }));
    }
    const additionalObjectProperties = typeof schema.additionalProperties ===
        "object" && _jsx(SchemaView, { schema: schema.additionalProperties, embedded: true });
    if (schema.type === "object") {
        const groupedProperties = groupBy(Object.entries(schema.properties ?? {}), ([propertyName, property]) => {
            return property.deprecated
                ? "deprecated"
                : schema.required?.includes(propertyName)
                    ? "required"
                    : "optional";
        });
        const groupNames = ["required", "optional", "deprecated"];
        const groups = groupNames.flatMap((group) => {
            const properties = groupedProperties[group];
            return properties ? { group, properties } : [];
        });
        const itemsList = groups.map(({ group, properties }, index) => (_jsxs(Fragment, { children: [index > 0 && _jsx(ItemSeparator, {}), _jsx(ItemGroup, { className: "overflow-clip", children: properties.map(([name, schema], index) => (_jsxs(Fragment, { children: [index > 0 && _jsx(ItemSeparator, {}), _jsx(SchemaPropertyItem, { name: name, schema: schema, group: group, defaultOpen: defaultOpen })] }, name))) })] }, group)));
        if (embedded) {
            return itemsList;
        }
        return (_jsxs(Frame, { children: [cardHeader, schema.description && (_jsx(FrameHeader, { children: _jsx(FrameDescription, { children: schema.description }) })), (itemsList.length > 0 || additionalObjectProperties) && (_jsxs(FramePanel, { className: "p-0!", children: [itemsList, additionalObjectProperties] })), schema.additionalProperties === true && (_jsx(FrameFooter, { children: _jsxs("a", { className: "text-sm flex items-center gap-1 hover:underline", href: "https://swagger.io/docs/specification/v3_0/data-models/dictionaries/", rel: "noopener noreferrer", target: "_blank", children: ["Additional properties are allowed", _jsx(InfoIcon, { size: 14 })] }) }))] }));
    }
};
//# sourceMappingURL=SchemaView.js.map