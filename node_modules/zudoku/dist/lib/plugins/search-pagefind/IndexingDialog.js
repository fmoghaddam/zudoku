import { Fragment as _Fragment, jsxs as _jsxs, jsx as _jsx } from "react/jsx-runtime";
import { DialogTrigger } from "@radix-ui/react-dialog";
import { useCallback, useEffect, useState, } from "react";
import { Button } from "zudoku/ui/Button.js";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, } from "zudoku/ui/Dialog.js";
const ProgressBar = ({ total, current, barLength = 25, emptyChar = "░", filledChar = "█", }) => {
    const percent = Math.round((current / total) * 100);
    const filled = Math.round((percent / 100) * barLength);
    const empty = barLength - filled;
    return (_jsxs(_Fragment, { children: [filledChar.repeat(filled), emptyChar.repeat(empty), " ", percent, "% (", current, "/", total, ")"] }));
};
const IndexingDialog = ({ children }) => {
    const [indexingState, setIndexingState] = useState({
        status: "idle",
    });
    const startIndexing = useCallback(() => {
        setIndexingState({ status: "indexing", total: 0, current: 0, path: "" });
        const eventSource = new EventSource("/__z/pagefind-reindex");
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "progress") {
                setIndexingState({
                    status: "indexing",
                    total: data.total,
                    current: data.current,
                    path: data.path,
                });
            }
            else if (data.type === "complete") {
                eventSource.close();
                if (data.success) {
                    setIndexingState({ status: "complete", indexed: data.indexed });
                }
                else {
                    setIndexingState({
                        status: "error",
                        message: data.error ?? "Indexing failed",
                    });
                }
            }
        };
        eventSource.onerror = () => {
            eventSource.close();
            setIndexingState({
                status: "error",
                message: "Connection lost during indexing",
            });
        };
        return () => eventSource.close();
    }, []);
    useEffect(() => {
        if (indexingState.status !== "idle")
            return;
        return startIndexing();
    }, [indexingState.status, startIndexing]);
    const handleDone = () => {
        if (indexingState.status !== "complete")
            return;
        window.location.reload();
    };
    return (_jsxs(Dialog, { children: [_jsx(DialogTrigger, { asChild: true, children: children }), _jsxs(DialogContent, { className: "max-w-sm! top-1/3", showCloseButton: false, onInteractOutside: (e) => e.preventDefault(), children: [_jsxs(DialogHeader, { children: [_jsxs(DialogTitle, { children: [indexingState.status === "indexing" && "Building Search Index", indexingState.status === "complete" && "Indexing Complete", indexingState.status === "error" && "Indexing Failed", indexingState.status === "idle" && "Build Search Index"] }), _jsxs(DialogDescription, { children: [indexingState.status === "indexing" && (_jsxs(_Fragment, { children: [indexingState.total > 0 && (_jsx("div", { className: "font-mono text-sm mb-2", children: _jsx(ProgressBar, { ...indexingState }) })), indexingState.path && (_jsx("span", { className: "block text-xs truncate", children: indexingState.path }))] })), indexingState.status === "complete" && (_jsxs(_Fragment, { children: ["Successfully indexed ", indexingState.indexed, " pages."] })), indexingState.status === "error" && (_jsx("span", { className: "text-destructive", children: indexingState.message }))] })] }), _jsx(DialogFooter, { children: _jsxs("div", { className: "flex justify-end gap-2", children: [indexingState.status === "complete" && (_jsx(Button, { size: "sm", onClick: handleDone, children: "Close and reload" })), indexingState.status === "error" && (_jsxs(_Fragment, { children: [_jsx(Button, { variant: "outline", onClick: handleDone, children: "Cancel" }), _jsx(Button, { onClick: startIndexing, children: "Retry" })] }))] }) })] })] }));
};
export default IndexingDialog;
//# sourceMappingURL=IndexingDialog.js.map