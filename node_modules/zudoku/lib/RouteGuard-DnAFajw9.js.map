{"version":3,"file":"RouteGuard-DnAFajw9.js","sources":["../src/lib/components/context/BypassProtectedRoutesContext.ts","../src/lib/core/RouteGuard.tsx"],"sourcesContent":["import { createContext } from \"react\";\n\nexport const BypassProtectedRoutesContext = createContext(false);\n","import { Helmet } from \"@zudoku/react-helmet-async\";\nimport { use, useCallback, useEffect, useMemo } from \"react\";\nimport {\n  matchPath,\n  Outlet,\n  useBlocker,\n  useLocation,\n  useNavigate,\n} from \"react-router\";\nimport { Button } from \"zudoku/ui/Button.js\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"zudoku/ui/Dialog.js\";\nimport { useAuth } from \"../authentication/hook.js\";\nimport { BypassProtectedRoutesContext } from \"../components/context/BypassProtectedRoutesContext.js\";\nimport { useZudoku } from \"../components/context/ZudokuContext.js\";\nimport { ZudokuError } from \"../util/invariant.js\";\n\nexport const SEARCH_PROTECTED_SECTION = \"protected\";\n\ntype LoginDialogProps = {\n  open: boolean;\n  onCancel: () => void;\n  onLogin: () => void;\n  onRegister: () => void;\n};\n\nconst LoginDialog = ({\n  open,\n  onCancel,\n  onLogin,\n  onRegister,\n}: LoginDialogProps) => (\n  <Dialog open={open} onOpenChange={(nextOpen) => !nextOpen && onCancel()}>\n    <DialogContent>\n      <DialogHeader>\n        <DialogTitle>Login to continue</DialogTitle>\n      </DialogHeader>\n      <DialogDescription>Please login to access this page.</DialogDescription>\n      <DialogFooter>\n        <Button variant=\"outline\" onClick={onCancel}>\n          Cancel\n        </Button>\n        <div className=\"w-full\" />\n        <Button variant=\"secondary\" onClick={onRegister}>\n          Register\n        </Button>\n        <Button onClick={onLogin}>Login</Button>\n      </DialogFooter>\n    </DialogContent>\n  </Dialog>\n);\n\nconst BypassRoute = ({ isProtectedRoute }: { isProtectedRoute: boolean }) => (\n  <>\n    {isProtectedRoute && (\n      <Helmet>\n        <meta\n          name=\"pagefind\"\n          data-pagefind-filter={`section:${SEARCH_PROTECTED_SECTION}`}\n          content=\"true\"\n        />\n      </Helmet>\n    )}\n    <Outlet />\n  </>\n);\n\nexport const RouteGuard = () => {\n  const auth = useAuth();\n  const zudoku = useZudoku();\n  const navigate = useNavigate();\n  const location = useLocation();\n  const shouldBypass = use(BypassProtectedRoutesContext);\n  const authCheckContext = useMemo(\n    () => ({ auth, context: zudoku }),\n    [auth, zudoku],\n  );\n  const { protectedRoutes } = zudoku;\n\n  const getAuthCheck = useCallback(\n    (pathname: string) => {\n      if (!protectedRoutes) return;\n      for (const [pattern, check] of Object.entries(protectedRoutes)) {\n        if (matchPath({ path: pattern, end: true }, pathname)) {\n          return check;\n        }\n      }\n    },\n    [protectedRoutes],\n  );\n\n  const currentAuthCheck = getAuthCheck(location.pathname);\n  const isProtectedRoute = currentAuthCheck !== undefined;\n  const isAuthorized = currentAuthCheck?.(authCheckContext) ?? true;\n  const needsToSignIn = isProtectedRoute && !isAuthorized;\n\n  const blocker = useBlocker(({ nextLocation }) => {\n    if (shouldBypass) return false;\n    const check = getAuthCheck(nextLocation.pathname);\n    return check !== undefined && !check(authCheckContext);\n  });\n  const isBlocked = blocker.state === \"blocked\";\n  const intendedPath = isBlocked ? blocker.location.pathname : undefined;\n\n  // Proceed after successful login\n  useEffect(() => {\n    if (!auth.isAuthenticated || !intendedPath) return;\n    const check = getAuthCheck(intendedPath);\n    if (!check || check(authCheckContext)) {\n      blocker.proceed?.();\n    }\n  }, [\n    auth.isAuthenticated,\n    intendedPath,\n    blocker,\n    authCheckContext,\n    getAuthCheck,\n  ]);\n\n  if (shouldBypass) {\n    return <BypassRoute isProtectedRoute={isProtectedRoute} />;\n  }\n\n  if (isProtectedRoute && !auth.isAuthEnabled) {\n    throw new ZudokuError(\"Authentication is not enabled\", {\n      title: \"Authentication is not enabled\",\n      developerHint:\n        \"To use protectedRoutes you need authentication to be enabled\",\n    });\n  }\n\n  if (needsToSignIn && auth.isPending && typeof window !== \"undefined\") {\n    return null;\n  }\n\n  const showDialog = needsToSignIn || isBlocked;\n  const redirectTo = intendedPath ?? location.pathname;\n\n  return (\n    <>\n      {!needsToSignIn && <Outlet />}\n      <LoginDialog\n        open={showDialog}\n        onCancel={needsToSignIn ? () => navigate(-1) : () => blocker.reset?.()}\n        onLogin={() => void auth.login({ redirectTo })}\n        onRegister={() => void auth.signup({ redirectTo })}\n      />\n    </>\n  );\n};\n"],"names":["BypassProtectedRoutesContext","createContext","SEARCH_PROTECTED_SECTION","LoginDialog","open","onCancel","onLogin","onRegister","jsx","Dialog","nextOpen","jsxs","DialogContent","DialogHeader","DialogTitle","DialogDescription","DialogFooter","Button","BypassRoute","isProtectedRoute","Fragment","Helmet","Outlet","RouteGuard","auth","useAuth","zudoku","useZudoku","navigate","useNavigate","location","useLocation","shouldBypass","use","authCheckContext","useMemo","protectedRoutes","getAuthCheck","useCallback","pathname","pattern","check","matchPath","currentAuthCheck","isAuthorized","needsToSignIn","blocker","useBlocker","nextLocation","isBlocked","intendedPath","useEffect","ZudokuError","showDialog","redirectTo"],"mappings":"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"}