{"version":3,"file":"zudoku.auth-supabase.js","sources":["../src/lib/authentication/providers/supabase/SupabaseAuthUI.tsx","../src/lib/authentication/providers/supabase.tsx"],"sourcesContent":["import { Auth } from \"@supabase/auth-ui-react\";\nimport {\n  ThemeSupa,\n  type ThemeVariables,\n  type ViewType,\n} from \"@supabase/auth-ui-shared\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { useSearchParams } from \"react-router\";\nimport type { SupabaseAuthenticationConfig } from \"../../../../config/config.js\";\nimport { Heading } from \"../../../components/Heading.js\";\n\nexport const SupabaseAuthUI = ({\n  client,\n  config,\n  view = \"sign_in\",\n}: {\n  client: SupabaseClient;\n  config: SupabaseAuthenticationConfig;\n  view: ViewType;\n}) => {\n  const [searchParams] = useSearchParams();\n  const redirectTo = searchParams.get(\"redirectTo\");\n  const providers = config.provider ? [config.provider] : config.providers;\n  const root = config.basePath ?? \"/\";\n  const redirectToAfterSignUp =\n    redirectTo ?? config.redirectToAfterSignUp ?? root;\n  const redirectToAfterSignIn =\n    redirectTo ?? config.redirectToAfterSignIn ?? root;\n  const redirectToAfterSignOut =\n    redirectTo ?? config.redirectToAfterSignOut ?? root;\n\n  return (\n    <div className=\"flex items-center justify-center\">\n      <div className=\"max-w-md w-full mt-10\">\n        <Heading level={1}>\n          {view === \"sign_in\" ? \"Sign in\" : \"Sign up\"}\n        </Heading>\n        <Auth\n          view={view}\n          redirectToAfterSignIn={redirectToAfterSignIn}\n          redirectToAfterSignUp={redirectToAfterSignUp}\n          redirectToAfterSignOut={redirectToAfterSignOut}\n          supabaseClient={client}\n          onlyThirdPartyProviders={config.onlyThirdPartyProviders}\n          appearance={{\n            theme: ThemeSupa,\n            variables: {\n              default: {\n                colors: {\n                  dividerBackground: \"var(--border)\",\n                  brand: \"var(--primary)\",\n                  brandAccent: \"hsla(from var(--primary) h s l / 0.8)\",\n                  brandButtonText: \"var(--primary-foreground)\",\n                  defaultButtonBorder: \"var(--border)\",\n                  inputBorder: \"var(--border)\",\n                  inputText: \"var(--foreground)\",\n                  inputBorderHover: \"var(--accent)\",\n                  defaultButtonBackground: \"var(--secondary)\",\n                  defaultButtonBackgroundHover: \"var(--accent)\",\n                },\n                radii: {\n                  borderRadiusButton: \"var(--radius)\",\n                  buttonBorderRadius: \"var(--radius)\",\n                  inputBorderRadius: \"var(--radius)\",\n                },\n              } satisfies ThemeVariables,\n            },\n          }}\n          providers={providers}\n          redirectTo={config.redirectToAfterSignIn ?? \"/\"}\n        />\n      </div>\n    </div>\n  );\n};\n","import {\n  createClient,\n  type Session,\n  type SupabaseClient,\n} from \"@supabase/supabase-js\";\nimport type { SupabaseAuthenticationConfig } from \"../../../config/config.js\";\nimport { CoreAuthenticationPlugin } from \"../AuthenticationPlugin.js\";\nimport type {\n  AuthActionContext,\n  AuthActionOptions,\n  AuthenticationPlugin,\n  AuthenticationProviderInitializer,\n} from \"../authentication.js\";\nimport { SignOut } from \"../components/SignOut.js\";\nimport { AuthorizationError } from \"../errors.js\";\nimport { type UserProfile, useAuthState } from \"../state.js\";\nimport { SupabaseAuthUI } from \"./supabase/SupabaseAuthUI.js\";\n\nclass SupabaseAuthenticationProvider\n  extends CoreAuthenticationPlugin\n  implements AuthenticationPlugin\n{\n  private readonly client: SupabaseClient;\n  private readonly config: SupabaseAuthenticationConfig;\n\n  constructor(config: SupabaseAuthenticationConfig) {\n    const { supabaseUrl, supabaseKey } = config;\n    super();\n\n    this.client = createClient(supabaseUrl, supabaseKey, {\n      auth: {\n        autoRefreshToken: true,\n        persistSession: true,\n      },\n    });\n    this.config = config;\n\n    this.client.auth.onAuthStateChange(async (event, session) => {\n      if (session && (event === \"SIGNED_IN\" || event === \"TOKEN_REFRESHED\")) {\n        await this.updateUserState(session);\n      } else if (event === \"SIGNED_OUT\") {\n        useAuthState.getState().setLoggedOut();\n      }\n    });\n  }\n\n  private async updateUserState(session: Session) {\n    const { user } = session;\n\n    const profile: UserProfile = {\n      sub: user.id,\n      email: user.email,\n      name: user.user_metadata.full_name || user.user_metadata.name,\n      emailVerified: user.email_confirmed_at != null,\n      pictureUrl: user.user_metadata.avatar_url,\n    };\n\n    useAuthState.getState().setLoggedIn({\n      profile,\n      providerData: { session },\n    });\n  }\n\n  async getAccessToken(): Promise<string> {\n    const { data, error } = await this.client.auth.getSession();\n\n    if (error || !data.session) {\n      throw new AuthorizationError(\"User is not authenticated\");\n    }\n\n    return data.session.access_token;\n  }\n\n  async signRequest(request: Request): Promise<Request> {\n    const accessToken = await this.getAccessToken();\n    request.headers.set(\"Authorization\", `Bearer ${accessToken}`);\n    return request;\n  }\n\n  signUp = async (\n    { navigate }: AuthActionContext,\n    { redirectTo }: AuthActionOptions,\n  ) => {\n    void navigate(\n      redirectTo\n        ? `/signup?redirectTo=${encodeURIComponent(redirectTo)}`\n        : `/signup`,\n    );\n  };\n\n  signIn = async (\n    { navigate }: AuthActionContext,\n    { redirectTo }: AuthActionOptions,\n  ) => {\n    void navigate(\n      redirectTo\n        ? `/signin?redirectTo=${encodeURIComponent(redirectTo)}`\n        : `/signin`,\n    );\n  };\n\n  getRoutes = () => {\n    return [\n      {\n        path: \"/signin\",\n        element: (\n          <SupabaseAuthUI\n            view=\"sign_in\"\n            client={this.client}\n            config={this.config}\n          />\n        ),\n      },\n      {\n        path: \"/signup\",\n        element: (\n          <SupabaseAuthUI\n            view=\"sign_up\"\n            client={this.client}\n            config={this.config}\n          />\n        ),\n      },\n      {\n        path: \"/signout\",\n        element: <SignOut />,\n      },\n    ];\n  };\n\n  signOut = async () => {\n    const { error } = await this.client.auth.signOut({ scope: \"local\" });\n    if (error) {\n      // biome-ignore lint/suspicious: Logging is better than not doing anything\n      console.error(\"Error signing out\", error);\n    }\n    useAuthState.getState().setLoggedOut();\n  };\n\n  onPageLoad = async () => {\n    const { data, error } = await this.client.auth.getSession();\n\n    if (!error && data.session) {\n      await this.updateUserState(data.session);\n    }\n  };\n}\n\nconst supabaseAuth: AuthenticationProviderInitializer<\n  SupabaseAuthenticationConfig\n> = (options) => new SupabaseAuthenticationProvider(options);\n\nexport default supabaseAuth;\n"],"names":["SupabaseAuthUI","client","config","view","searchParams","useSearchParams","redirectTo","providers","root","redirectToAfterSignUp","redirectToAfterSignIn","redirectToAfterSignOut","jsxs","jsx","Heading","Auth","ThemeSupa","SupabaseAuthenticationProvider","CoreAuthenticationPlugin","supabaseUrl","supabaseKey","createClient","event","session","useAuthState","user","profile","data","error","AuthorizationError","request","accessToken","navigate","SignOut","supabaseAuth","options"],"mappings":"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"}