{"version":3,"file":"zudoku.auth-clerk.js","sources":["../src/lib/authentication/providers/clerk.tsx"],"sourcesContent":["import type { Clerk } from \"@clerk/clerk-js\";\nimport { LogOutIcon } from \"lucide-react\";\nimport type { ZudokuPlugin } from \"zudoku/plugins\";\nimport type { ClerkAuthenticationConfig } from \"../../../config/config.js\";\nimport type {\n  AuthActionContext,\n  AuthenticationPlugin,\n  AuthenticationProviderInitializer,\n} from \"../authentication.js\";\nimport { SignIn } from \"../components/SignIn.js\";\nimport { SignOut } from \"../components/SignOut.js\";\nimport { SignUp } from \"../components/SignUp.js\";\nimport { type UserProfile, useAuthState } from \"../state.js\";\n\nconst clerkAuth: AuthenticationProviderInitializer<\n  ClerkAuthenticationConfig\n> = ({\n  clerkPubKey,\n  jwtTemplateName,\n  redirectToAfterSignOut = \"/\",\n  redirectToAfterSignUp,\n  redirectToAfterSignIn,\n}): AuthenticationPlugin & ZudokuPlugin => {\n  let clerkApi: Clerk | undefined;\n  const ensureLoaded = (async () => {\n    if (typeof window === \"undefined\") return;\n    const { Clerk } = await import(\"@clerk/clerk-js\");\n    clerkApi = new Clerk(clerkPubKey);\n\n    await clerkApi.load();\n\n    return clerkApi;\n  })();\n\n  async function getAccessToken() {\n    await ensureLoaded;\n    if (!clerkApi?.session) {\n      throw new Error(\"No session available\");\n    }\n    const response = await clerkApi.session.getToken({\n      template: jwtTemplateName,\n    });\n    if (!response) {\n      throw new Error(\"Could not get access token from Clerk\");\n    }\n    return response;\n  }\n\n  async function getUserProfile(\n    clerk: Clerk,\n  ): Promise<UserProfile | undefined> {\n    if (!clerk.session?.user) {\n      return undefined;\n    }\n\n    const verifiedEmail = clerk.session?.user?.emailAddresses.find(\n      (email) => email.verification.status === \"verified\",\n    );\n\n    return {\n      sub: clerk.session?.user?.id ?? \"\",\n      email:\n        verifiedEmail?.emailAddress ??\n        clerk.session?.user?.emailAddresses[0]?.emailAddress ??\n        \"\",\n      name: clerk.session?.user?.fullName ?? \"\",\n      emailVerified: !!verifiedEmail?.emailAddress,\n      pictureUrl: clerk.session?.user?.imageUrl ?? \"\",\n    };\n  }\n\n  async function refreshUserProfile() {\n    const clerk = await ensureLoaded;\n    if (!clerk) {\n      return false;\n    }\n\n    await clerk.session?.user?.reload();\n\n    const profile = await getUserProfile(clerk);\n\n    if (!profile) {\n      return false;\n    }\n\n    useAuthState.setState({\n      isAuthenticated: true,\n      isPending: false,\n      profile,\n      providerData: {\n        user: clerk.session?.user,\n      },\n    });\n\n    return true;\n  }\n\n  async function signRequest(request: Request): Promise<Request> {\n    const response = await getAccessToken();\n    request.headers.set(\"Authorization\", `Bearer ${response}`);\n    return request;\n  }\n\n  return {\n    getRoutes: () => {\n      return [\n        {\n          path: \"/signout\",\n          element: <SignOut />,\n        },\n        {\n          path: \"/signin\",\n          element: <SignIn />,\n        },\n        {\n          path: \"/signup\",\n          element: <SignUp />,\n        },\n      ];\n    },\n\n    refreshUserProfile,\n\n    getProfileMenuItems() {\n      return [\n        {\n          label: \"Logout\",\n          path: \"/signout\",\n          category: \"bottom\",\n          icon: LogOutIcon,\n        } as const,\n      ];\n    },\n    initialize: async () => {\n      const clerk = await ensureLoaded;\n\n      if (!clerk) {\n        return;\n      }\n\n      if (clerk.session) {\n        const profile = await getUserProfile(clerk);\n\n        if (!profile) {\n          useAuthState.getState().setLoggedOut();\n          return;\n        }\n\n        useAuthState.getState().setLoggedIn({\n          profile,\n          providerData: {\n            user: clerk.session.user,\n          },\n        });\n      } else {\n        useAuthState.getState().setLoggedOut();\n      }\n    },\n    getAccessToken,\n    signRequest,\n    signOut: async () => {\n      await ensureLoaded;\n      useAuthState.getState().setLoggedOut();\n      await clerkApi?.signOut({\n        redirectUrl: window.location.origin + redirectToAfterSignOut,\n      });\n    },\n    signIn: async (\n      _: AuthActionContext,\n      { redirectTo }: { redirectTo?: string } = {},\n    ) => {\n      await ensureLoaded;\n      await clerkApi?.redirectToSignIn({\n        signInForceRedirectUrl: redirectToAfterSignIn\n          ? window.location.origin + redirectToAfterSignIn\n          : redirectTo,\n        signUpForceRedirectUrl: redirectToAfterSignUp\n          ? window.location.origin + redirectToAfterSignUp\n          : redirectTo,\n      });\n    },\n    signUp: async (\n      _: AuthActionContext,\n      { redirectTo }: { redirectTo?: string } = {},\n    ) => {\n      await ensureLoaded;\n      await clerkApi?.redirectToSignUp({\n        signInForceRedirectUrl: redirectToAfterSignIn\n          ? window.location.origin + redirectToAfterSignIn\n          : redirectTo,\n        signUpForceRedirectUrl: redirectToAfterSignUp\n          ? window.location.origin + redirectToAfterSignUp\n          : redirectTo,\n      });\n    },\n  };\n};\n\nexport default clerkAuth;\n"],"names":["clerkAuth","clerkPubKey","jwtTemplateName","redirectToAfterSignOut","redirectToAfterSignUp","redirectToAfterSignIn","clerkApi","ensureLoaded","Clerk","getAccessToken","response","getUserProfile","clerk","verifiedEmail","email","refreshUserProfile","profile","useAuthState","signRequest","request","SignOut","SignIn","SignUp","LogOutIcon","_","redirectTo"],"mappings":"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"}