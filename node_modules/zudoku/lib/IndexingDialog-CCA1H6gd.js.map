{"version":3,"file":"IndexingDialog-CCA1H6gd.js","sources":["../src/lib/plugins/search-pagefind/IndexingDialog.tsx"],"sourcesContent":["import { DialogTrigger } from \"@radix-ui/react-dialog\";\nimport {\n  type PropsWithChildren,\n  useCallback,\n  useEffect,\n  useState,\n} from \"react\";\nimport { Button } from \"zudoku/ui/Button.js\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"zudoku/ui/Dialog.js\";\n\ntype IndexingState =\n  | { status: \"idle\" }\n  | { status: \"indexing\"; total: number; current: number; path: string }\n  | { status: \"complete\"; indexed: number }\n  | { status: \"error\"; message: string };\n\nconst ProgressBar = ({\n  total,\n  current,\n  barLength = 25,\n  emptyChar = \"░\",\n  filledChar = \"█\",\n}: {\n  total: number;\n  current: number;\n  barLength?: number;\n  emptyChar?: string;\n  filledChar?: string;\n}) => {\n  const percent = Math.round((current / total) * 100);\n  const filled = Math.round((percent / 100) * barLength);\n  const empty = barLength - filled;\n\n  return (\n    <>\n      {filledChar.repeat(filled)}\n      {emptyChar.repeat(empty)} {percent}% ({current}/{total})\n    </>\n  );\n};\n\nconst IndexingDialog = ({ children }: PropsWithChildren) => {\n  const [indexingState, setIndexingState] = useState<IndexingState>({\n    status: \"idle\",\n  });\n\n  const startIndexing = useCallback(() => {\n    setIndexingState({ status: \"indexing\", total: 0, current: 0, path: \"\" });\n\n    const eventSource = new EventSource(\"/__z/pagefind-reindex\");\n\n    eventSource.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n\n      if (data.type === \"progress\") {\n        setIndexingState({\n          status: \"indexing\",\n          total: data.total,\n          current: data.current,\n          path: data.path,\n        });\n      } else if (data.type === \"complete\") {\n        eventSource.close();\n        if (data.success) {\n          setIndexingState({ status: \"complete\", indexed: data.indexed });\n        } else {\n          setIndexingState({\n            status: \"error\",\n            message: data.error ?? \"Indexing failed\",\n          });\n        }\n      }\n    };\n\n    eventSource.onerror = () => {\n      eventSource.close();\n      setIndexingState({\n        status: \"error\",\n        message: \"Connection lost during indexing\",\n      });\n    };\n\n    return () => eventSource.close();\n  }, []);\n\n  useEffect(() => {\n    if (indexingState.status !== \"idle\") return;\n    return startIndexing();\n  }, [indexingState.status, startIndexing]);\n\n  const handleDone = () => {\n    if (indexingState.status !== \"complete\") return;\n    window.location.reload();\n  };\n\n  return (\n    <Dialog>\n      <DialogTrigger asChild>{children}</DialogTrigger>\n      <DialogContent\n        className=\"max-w-sm! top-1/3\"\n        showCloseButton={false}\n        onInteractOutside={(e) => e.preventDefault()}\n      >\n        <DialogHeader>\n          <DialogTitle>\n            {indexingState.status === \"indexing\" && \"Building Search Index\"}\n            {indexingState.status === \"complete\" && \"Indexing Complete\"}\n            {indexingState.status === \"error\" && \"Indexing Failed\"}\n            {indexingState.status === \"idle\" && \"Build Search Index\"}\n          </DialogTitle>\n          <DialogDescription>\n            {indexingState.status === \"indexing\" && (\n              <>\n                {indexingState.total > 0 && (\n                  <div className=\"font-mono text-sm mb-2\">\n                    <ProgressBar {...indexingState} />\n                  </div>\n                )}\n                {indexingState.path && (\n                  <span className=\"block text-xs truncate\">\n                    {indexingState.path}\n                  </span>\n                )}\n              </>\n            )}\n            {indexingState.status === \"complete\" && (\n              <>Successfully indexed {indexingState.indexed} pages.</>\n            )}\n            {indexingState.status === \"error\" && (\n              <span className=\"text-destructive\">{indexingState.message}</span>\n            )}\n          </DialogDescription>\n        </DialogHeader>\n        <DialogFooter>\n          <div className=\"flex justify-end gap-2\">\n            {indexingState.status === \"complete\" && (\n              <Button size=\"sm\" onClick={handleDone}>\n                Close and reload\n              </Button>\n            )}\n            {indexingState.status === \"error\" && (\n              <>\n                <Button variant=\"outline\" onClick={handleDone}>\n                  Cancel\n                </Button>\n                <Button onClick={startIndexing}>Retry</Button>\n              </>\n            )}\n          </div>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default IndexingDialog;\n"],"names":["ProgressBar","total","current","barLength","emptyChar","filledChar","percent","filled","empty","jsxs","Fragment","IndexingDialog","children","indexingState","setIndexingState","useState","startIndexing","useCallback","eventSource","event","data","useEffect","handleDone","Dialog","jsx","DialogTrigger","DialogContent","e","DialogHeader","DialogTitle","DialogDescription","DialogFooter","Button"],"mappings":"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"}